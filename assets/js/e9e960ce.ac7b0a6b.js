"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[3853],{3905:function(e,a,t){t.r(a),t.d(a,{MDXContext:function(){return o},MDXProvider:function(){return c},mdx:function(){return x},useMDXComponents:function(){return d},withMDXComponents:function(){return l}});var n=t(67294);function s(e,a,t){return a in e?Object.defineProperty(e,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[a]=t,e}function m(){return m=Object.assign||function(e){for(var a=1;a<arguments.length;a++){var t=arguments[a];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e},m.apply(this,arguments)}function r(e,a){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);a&&(n=n.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),t.push.apply(t,n)}return t}function p(e){for(var a=1;a<arguments.length;a++){var t=null!=arguments[a]?arguments[a]:{};a%2?r(Object(t),!0).forEach((function(a){s(e,a,t[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))}))}return e}function i(e,a){if(null==e)return{};var t,n,s=function(e,a){if(null==e)return{};var t,n,s={},m=Object.keys(e);for(n=0;n<m.length;n++)t=m[n],a.indexOf(t)>=0||(s[t]=e[t]);return s}(e,a);if(Object.getOwnPropertySymbols){var m=Object.getOwnPropertySymbols(e);for(n=0;n<m.length;n++)t=m[n],a.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(s[t]=e[t])}return s}var o=n.createContext({}),l=function(e){return function(a){var t=d(a.components);return n.createElement(e,m({},a,{components:t}))}},d=function(e){var a=n.useContext(o),t=a;return e&&(t="function"==typeof e?e(a):p(p({},a),e)),t},c=function(e){var a=d(e.components);return n.createElement(o.Provider,{value:a},e.children)},N={inlineCode:"code",wrapper:function(e){var a=e.children;return n.createElement(n.Fragment,{},a)}},h=n.forwardRef((function(e,a){var t=e.components,s=e.mdxType,m=e.originalType,r=e.parentName,o=i(e,["components","mdxType","originalType","parentName"]),l=d(t),c=s,h=l["".concat(r,".").concat(c)]||l[c]||N[c]||m;return t?n.createElement(h,p(p({ref:a},o),{},{components:t})):n.createElement(h,p({ref:a},o))}));function x(e,a){var t=arguments,s=a&&a.mdxType;if("string"==typeof e||s){var m=t.length,r=new Array(m);r[0]=h;var p={};for(var i in a)hasOwnProperty.call(a,i)&&(p[i]=a[i]);p.originalType=e,p.mdxType="string"==typeof e?e:s,r[1]=p;for(var o=2;o<m;o++)r[o]=t[o];return n.createElement.apply(null,r)}return n.createElement.apply(null,t)}h.displayName="MDXCreateElement"},37678:function(e,a,t){t.r(a),t.d(a,{frontMatter:function(){return p},contentTitle:function(){return i},metadata:function(){return o},toc:function(){return l},default:function(){return c}});var n=t(87462),s=t(63366),m=(t(67294),t(3905)),r=["components"],p={title:"Custom Proposers",sidebar_label:"Custom Proposers",slug:"/custom_proposers"},i=void 0,o={unversionedId:"framework_topics/custom_inference/custom_proposers",id:"framework_topics/custom_inference/custom_proposers",title:"Custom Proposers",description:"API",source:"@site/../docs/framework_topics/custom_inference/custom_proposers.md",sourceDirName:"framework_topics/custom_inference",slug:"/custom_proposers",permalink:"/docs/custom_proposers",editUrl:"https://github.com/facebookresearch/beanmachine/edit/main/website/../docs/framework_topics/custom_inference/custom_proposers.md",tags:[],version:"current",frontMatter:{title:"Custom Proposers",sidebar_label:"Custom Proposers",slug:"/custom_proposers"},sidebar:"someSidebar",previous:{title:"Overview",permalink:"/docs/programmable_inference"},next:{title:"Compositional Inference",permalink:"/docs/compositional_inference"}},l=[{value:"API",id:"api",children:[],level:2},{value:"Example Custom Proposer",id:"example-custom-proposer",children:[],level:2}],d={toc:l};function c(e){var a=e.components,t=(0,s.Z)(e,r);return(0,m.mdx)("wrapper",(0,n.Z)({},d,t,{components:a,mdxType:"MDXLayout"}),(0,m.mdx)("h2",{id:"api"},"API"),(0,m.mdx)("p",null,"Bean Machine is flexible and allows users to supply custom MCMC proposers. This enables users to easily incorporate domain knowledge or exploit model structure during inference."),(0,m.mdx)("p",null,"We will focus on ",(0,m.mdx)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Metropolis%E2%80%93Hastings_algorithm"},"Metropolis Hastings algorithm"),", the most common flavor of MCMC inference.\nFor each iteration of sampling of variable ",(0,m.mdx)("span",{parentName:"p",className:"math math-inline"},(0,m.mdx)("span",{parentName:"span",className:"katex"},(0,m.mdx)("span",{parentName:"span",className:"katex-mathml"},(0,m.mdx)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML"},(0,m.mdx)("semantics",{parentName:"math"},(0,m.mdx)("mrow",{parentName:"semantics"},(0,m.mdx)("mi",{parentName:"mrow"},"X")),(0,m.mdx)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"X")))),(0,m.mdx)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,m.mdx)("span",{parentName:"span",className:"base"},(0,m.mdx)("span",{parentName:"span",className:"strut",style:{height:"0.68333em",verticalAlign:"0em"}}),(0,m.mdx)("span",{parentName:"span",className:"mord mathnormal",style:{marginRight:"0.07847em"}},"X")))))," with value ",(0,m.mdx)("span",{parentName:"p",className:"math math-inline"},(0,m.mdx)("span",{parentName:"span",className:"katex"},(0,m.mdx)("span",{parentName:"span",className:"katex-mathml"},(0,m.mdx)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML"},(0,m.mdx)("semantics",{parentName:"math"},(0,m.mdx)("mrow",{parentName:"semantics"},(0,m.mdx)("mi",{parentName:"mrow"},"x")),(0,m.mdx)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"x")))),(0,m.mdx)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,m.mdx)("span",{parentName:"span",className:"base"},(0,m.mdx)("span",{parentName:"span",className:"strut",style:{height:"0.43056em",verticalAlign:"0em"}}),(0,m.mdx)("span",{parentName:"span",className:"mord mathnormal"},"x")))))," using the MH algorithm, we first sample a new value ",(0,m.mdx)("span",{parentName:"p",className:"math math-inline"},(0,m.mdx)("span",{parentName:"span",className:"katex"},(0,m.mdx)("span",{parentName:"span",className:"katex-mathml"},(0,m.mdx)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML"},(0,m.mdx)("semantics",{parentName:"math"},(0,m.mdx)("mrow",{parentName:"semantics"},(0,m.mdx)("msup",{parentName:"mrow"},(0,m.mdx)("mi",{parentName:"msup"},"x"),(0,m.mdx)("mo",{parentName:"msup",mathvariant:"normal",lspace:"0em",rspace:"0em"},"\u2032"))),(0,m.mdx)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"x'")))),(0,m.mdx)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,m.mdx)("span",{parentName:"span",className:"base"},(0,m.mdx)("span",{parentName:"span",className:"strut",style:{height:"0.751892em",verticalAlign:"0em"}}),(0,m.mdx)("span",{parentName:"span",className:"mord"},(0,m.mdx)("span",{parentName:"span",className:"mord mathnormal"},"x"),(0,m.mdx)("span",{parentName:"span",className:"msupsub"},(0,m.mdx)("span",{parentName:"span",className:"vlist-t"},(0,m.mdx)("span",{parentName:"span",className:"vlist-r"},(0,m.mdx)("span",{parentName:"span",className:"vlist",style:{height:"0.751892em"}},(0,m.mdx)("span",{parentName:"span",style:{top:"-3.063em",marginRight:"0.05em"}},(0,m.mdx)("span",{parentName:"span",className:"pstrut",style:{height:"2.7em"}}),(0,m.mdx)("span",{parentName:"span",className:"sizing reset-size6 size3 mtight"},(0,m.mdx)("span",{parentName:"span",className:"mord mtight"},(0,m.mdx)("span",{parentName:"span",className:"mord mtight"},"\u2032")))))))))))))," for ",(0,m.mdx)("span",{parentName:"p",className:"math math-inline"},(0,m.mdx)("span",{parentName:"span",className:"katex"},(0,m.mdx)("span",{parentName:"span",className:"katex-mathml"},(0,m.mdx)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML"},(0,m.mdx)("semantics",{parentName:"math"},(0,m.mdx)("mrow",{parentName:"semantics"},(0,m.mdx)("mi",{parentName:"mrow"},"X")),(0,m.mdx)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"X")))),(0,m.mdx)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,m.mdx)("span",{parentName:"span",className:"base"},(0,m.mdx)("span",{parentName:"span",className:"strut",style:{height:"0.68333em",verticalAlign:"0em"}}),(0,m.mdx)("span",{parentName:"span",className:"mord mathnormal",style:{marginRight:"0.07847em"}},"X")))))," using proposal distribution ",(0,m.mdx)("span",{parentName:"p",className:"math math-inline"},(0,m.mdx)("span",{parentName:"span",className:"katex"},(0,m.mdx)("span",{parentName:"span",className:"katex-mathml"},(0,m.mdx)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML"},(0,m.mdx)("semantics",{parentName:"math"},(0,m.mdx)("mrow",{parentName:"semantics"},(0,m.mdx)("mi",{parentName:"mrow"},"g")),(0,m.mdx)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"g")))),(0,m.mdx)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,m.mdx)("span",{parentName:"span",className:"base"},(0,m.mdx)("span",{parentName:"span",className:"strut",style:{height:"0.625em",verticalAlign:"-0.19444em"}}),(0,m.mdx)("span",{parentName:"span",className:"mord mathnormal",style:{marginRight:"0.03588em"}},"g"))))),".\nWe then update the world to reflect this change, and use the Metropolis Hastings ratio of\n",(0,m.mdx)("span",{parentName:"p",className:"math math-inline"},(0,m.mdx)("span",{parentName:"span",className:"katex"},(0,m.mdx)("span",{parentName:"span",className:"katex-mathml"},(0,m.mdx)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML"},(0,m.mdx)("semantics",{parentName:"math"},(0,m.mdx)("mrow",{parentName:"semantics"},(0,m.mdx)("mtext",{parentName:"mrow"},"min"),(0,m.mdx)("mo",{parentName:"mrow",fence:"false"},"["),(0,m.mdx)("mn",{parentName:"mrow"},"1"),(0,m.mdx)("mo",{parentName:"mrow",separator:"true"},","),(0,m.mdx)("mfrac",{parentName:"mrow"},(0,m.mdx)("mrow",{parentName:"mfrac"},(0,m.mdx)("mi",{parentName:"mrow"},"p"),(0,m.mdx)("mo",{parentName:"mrow",stretchy:"false"},"("),(0,m.mdx)("msup",{parentName:"mrow"},(0,m.mdx)("mi",{parentName:"msup"},"x"),(0,m.mdx)("mo",{parentName:"msup",mathvariant:"normal",lspace:"0em",rspace:"0em"},"\u2032")),(0,m.mdx)("mo",{parentName:"mrow",stretchy:"false"},")"),(0,m.mdx)("mi",{parentName:"mrow"},"g"),(0,m.mdx)("mo",{parentName:"mrow",stretchy:"false"},"("),(0,m.mdx)("mi",{parentName:"mrow"},"x"),(0,m.mdx)("mo",{parentName:"mrow"},"\u2223"),(0,m.mdx)("msup",{parentName:"mrow"},(0,m.mdx)("mi",{parentName:"msup"},"x"),(0,m.mdx)("mo",{parentName:"msup",mathvariant:"normal",lspace:"0em",rspace:"0em"},"\u2032")),(0,m.mdx)("mo",{parentName:"mrow",stretchy:"false"},")")),(0,m.mdx)("mrow",{parentName:"mfrac"},(0,m.mdx)("mi",{parentName:"mrow"},"p"),(0,m.mdx)("mo",{parentName:"mrow",stretchy:"false"},"("),(0,m.mdx)("mi",{parentName:"mrow"},"x"),(0,m.mdx)("mo",{parentName:"mrow",stretchy:"false"},")"),(0,m.mdx)("mi",{parentName:"mrow"},"g"),(0,m.mdx)("mo",{parentName:"mrow",stretchy:"false"},"("),(0,m.mdx)("msup",{parentName:"mrow"},(0,m.mdx)("mi",{parentName:"msup"},"x"),(0,m.mdx)("mo",{parentName:"msup",mathvariant:"normal",lspace:"0em",rspace:"0em"},"\u2032")),(0,m.mdx)("mo",{parentName:"mrow"},"\u2223"),(0,m.mdx)("mi",{parentName:"mrow"},"x"),(0,m.mdx)("mo",{parentName:"mrow",stretchy:"false"},")"))),(0,m.mdx)("mo",{parentName:"mrow",fence:"false"},"]")),(0,m.mdx)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"\\text{min}\\big[1, \\frac{p(x')g(x \\mid x')}{p(x)g(x' \\mid x)}\\big]")))),(0,m.mdx)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,m.mdx)("span",{parentName:"span",className:"base"},(0,m.mdx)("span",{parentName:"span",className:"strut",style:{height:"1.58448em",verticalAlign:"-0.52em"}}),(0,m.mdx)("span",{parentName:"span",className:"mord text"},(0,m.mdx)("span",{parentName:"span",className:"mord"},"min")),(0,m.mdx)("span",{parentName:"span",className:"mord"},(0,m.mdx)("span",{parentName:"span",className:"delimsizing size1"},"[")),(0,m.mdx)("span",{parentName:"span",className:"mord"},"1"),(0,m.mdx)("span",{parentName:"span",className:"mpunct"},","),(0,m.mdx)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.16666666666666666em"}}),(0,m.mdx)("span",{parentName:"span",className:"mord"},(0,m.mdx)("span",{parentName:"span",className:"mopen nulldelimiter"}),(0,m.mdx)("span",{parentName:"span",className:"mfrac"},(0,m.mdx)("span",{parentName:"span",className:"vlist-t vlist-t2"},(0,m.mdx)("span",{parentName:"span",className:"vlist-r"},(0,m.mdx)("span",{parentName:"span",className:"vlist",style:{height:"1.06448em"}},(0,m.mdx)("span",{parentName:"span",style:{top:"-2.655em"}},(0,m.mdx)("span",{parentName:"span",className:"pstrut",style:{height:"3em"}}),(0,m.mdx)("span",{parentName:"span",className:"sizing reset-size6 size3 mtight"},(0,m.mdx)("span",{parentName:"span",className:"mord mtight"},(0,m.mdx)("span",{parentName:"span",className:"mord mathnormal mtight"},"p"),(0,m.mdx)("span",{parentName:"span",className:"mopen mtight"},"("),(0,m.mdx)("span",{parentName:"span",className:"mord mathnormal mtight"},"x"),(0,m.mdx)("span",{parentName:"span",className:"mclose mtight"},")"),(0,m.mdx)("span",{parentName:"span",className:"mord mathnormal mtight",style:{marginRight:"0.03588em"}},"g"),(0,m.mdx)("span",{parentName:"span",className:"mopen mtight"},"("),(0,m.mdx)("span",{parentName:"span",className:"mord mtight"},(0,m.mdx)("span",{parentName:"span",className:"mord mathnormal mtight"},"x"),(0,m.mdx)("span",{parentName:"span",className:"msupsub"},(0,m.mdx)("span",{parentName:"span",className:"vlist-t"},(0,m.mdx)("span",{parentName:"span",className:"vlist-r"},(0,m.mdx)("span",{parentName:"span",className:"vlist",style:{height:"0.6828285714285715em"}},(0,m.mdx)("span",{parentName:"span",style:{top:"-2.786em",marginRight:"0.07142857142857144em"}},(0,m.mdx)("span",{parentName:"span",className:"pstrut",style:{height:"2.5em"}}),(0,m.mdx)("span",{parentName:"span",className:"sizing reset-size3 size1 mtight"},(0,m.mdx)("span",{parentName:"span",className:"mord mtight"},(0,m.mdx)("span",{parentName:"span",className:"mord mtight"},"\u2032"))))))))),(0,m.mdx)("span",{parentName:"span",className:"mrel mtight"},"\u2223"),(0,m.mdx)("span",{parentName:"span",className:"mord mathnormal mtight"},"x"),(0,m.mdx)("span",{parentName:"span",className:"mclose mtight"},")")))),(0,m.mdx)("span",{parentName:"span",style:{top:"-3.23em"}},(0,m.mdx)("span",{parentName:"span",className:"pstrut",style:{height:"3em"}}),(0,m.mdx)("span",{parentName:"span",className:"frac-line",style:{borderBottomWidth:"0.04em"}})),(0,m.mdx)("span",{parentName:"span",style:{top:"-3.485em"}},(0,m.mdx)("span",{parentName:"span",className:"pstrut",style:{height:"3em"}}),(0,m.mdx)("span",{parentName:"span",className:"sizing reset-size6 size3 mtight"},(0,m.mdx)("span",{parentName:"span",className:"mord mtight"},(0,m.mdx)("span",{parentName:"span",className:"mord mathnormal mtight"},"p"),(0,m.mdx)("span",{parentName:"span",className:"mopen mtight"},"("),(0,m.mdx)("span",{parentName:"span",className:"mord mtight"},(0,m.mdx)("span",{parentName:"span",className:"mord mathnormal mtight"},"x"),(0,m.mdx)("span",{parentName:"span",className:"msupsub"},(0,m.mdx)("span",{parentName:"span",className:"vlist-t"},(0,m.mdx)("span",{parentName:"span",className:"vlist-r"},(0,m.mdx)("span",{parentName:"span",className:"vlist",style:{height:"0.8278285714285715em"}},(0,m.mdx)("span",{parentName:"span",style:{top:"-2.931em",marginRight:"0.07142857142857144em"}},(0,m.mdx)("span",{parentName:"span",className:"pstrut",style:{height:"2.5em"}}),(0,m.mdx)("span",{parentName:"span",className:"sizing reset-size3 size1 mtight"},(0,m.mdx)("span",{parentName:"span",className:"mord mtight"},(0,m.mdx)("span",{parentName:"span",className:"mord mtight"},"\u2032"))))))))),(0,m.mdx)("span",{parentName:"span",className:"mclose mtight"},")"),(0,m.mdx)("span",{parentName:"span",className:"mord mathnormal mtight",style:{marginRight:"0.03588em"}},"g"),(0,m.mdx)("span",{parentName:"span",className:"mopen mtight"},"("),(0,m.mdx)("span",{parentName:"span",className:"mord mathnormal mtight"},"x"),(0,m.mdx)("span",{parentName:"span",className:"mrel mtight"},"\u2223"),(0,m.mdx)("span",{parentName:"span",className:"mord mtight"},(0,m.mdx)("span",{parentName:"span",className:"mord mathnormal mtight"},"x"),(0,m.mdx)("span",{parentName:"span",className:"msupsub"},(0,m.mdx)("span",{parentName:"span",className:"vlist-t"},(0,m.mdx)("span",{parentName:"span",className:"vlist-r"},(0,m.mdx)("span",{parentName:"span",className:"vlist",style:{height:"0.8278285714285715em"}},(0,m.mdx)("span",{parentName:"span",style:{top:"-2.931em",marginRight:"0.07142857142857144em"}},(0,m.mdx)("span",{parentName:"span",className:"pstrut",style:{height:"2.5em"}}),(0,m.mdx)("span",{parentName:"span",className:"sizing reset-size3 size1 mtight"},(0,m.mdx)("span",{parentName:"span",className:"mord mtight"},(0,m.mdx)("span",{parentName:"span",className:"mord mtight"},"\u2032"))))))))),(0,m.mdx)("span",{parentName:"span",className:"mclose mtight"},")"))))),(0,m.mdx)("span",{parentName:"span",className:"vlist-s"},"\u200b")),(0,m.mdx)("span",{parentName:"span",className:"vlist-r"},(0,m.mdx)("span",{parentName:"span",className:"vlist",style:{height:"0.52em"}},(0,m.mdx)("span",{parentName:"span"}))))),(0,m.mdx)("span",{parentName:"span",className:"mclose nulldelimiter"})),(0,m.mdx)("span",{parentName:"span",className:"mord"},(0,m.mdx)("span",{parentName:"span",className:"delimsizing size1"},"]")))))),"\nto decide whether to keep the update or to revert to the world as it was before it."),(0,m.mdx)("p",null,"Bean Machine allows users to easily provide custom proposals for ",(0,m.mdx)("span",{parentName:"p",className:"math math-inline"},(0,m.mdx)("span",{parentName:"span",className:"katex"},(0,m.mdx)("span",{parentName:"span",className:"katex-mathml"},(0,m.mdx)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML"},(0,m.mdx)("semantics",{parentName:"math"},(0,m.mdx)("mrow",{parentName:"semantics"},(0,m.mdx)("mi",{parentName:"mrow"},"g")),(0,m.mdx)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"g")))),(0,m.mdx)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,m.mdx)("span",{parentName:"span",className:"base"},(0,m.mdx)("span",{parentName:"span",className:"strut",style:{height:"0.625em",verticalAlign:"-0.19444em"}}),(0,m.mdx)("span",{parentName:"span",className:"mord mathnormal",style:{marginRight:"0.03588em"}},"g"))))),", without needing to implement other details such as the calculations for ",(0,m.mdx)("span",{parentName:"p",className:"math math-inline"},(0,m.mdx)("span",{parentName:"span",className:"katex"},(0,m.mdx)("span",{parentName:"span",className:"katex-mathml"},(0,m.mdx)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML"},(0,m.mdx)("semantics",{parentName:"math"},(0,m.mdx)("mrow",{parentName:"semantics"},(0,m.mdx)("mi",{parentName:"mrow"},"p"),(0,m.mdx)("mo",{parentName:"mrow",stretchy:"false"},"("),(0,m.mdx)("msup",{parentName:"mrow"},(0,m.mdx)("mi",{parentName:"msup"},"x"),(0,m.mdx)("mo",{parentName:"msup",mathvariant:"normal",lspace:"0em",rspace:"0em"},"\u2032")),(0,m.mdx)("mo",{parentName:"mrow",stretchy:"false"},")")),(0,m.mdx)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"p(x')")))),(0,m.mdx)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,m.mdx)("span",{parentName:"span",className:"base"},(0,m.mdx)("span",{parentName:"span",className:"strut",style:{height:"1.001892em",verticalAlign:"-0.25em"}}),(0,m.mdx)("span",{parentName:"span",className:"mord mathnormal"},"p"),(0,m.mdx)("span",{parentName:"span",className:"mopen"},"("),(0,m.mdx)("span",{parentName:"span",className:"mord"},(0,m.mdx)("span",{parentName:"span",className:"mord mathnormal"},"x"),(0,m.mdx)("span",{parentName:"span",className:"msupsub"},(0,m.mdx)("span",{parentName:"span",className:"vlist-t"},(0,m.mdx)("span",{parentName:"span",className:"vlist-r"},(0,m.mdx)("span",{parentName:"span",className:"vlist",style:{height:"0.751892em"}},(0,m.mdx)("span",{parentName:"span",style:{top:"-3.063em",marginRight:"0.05em"}},(0,m.mdx)("span",{parentName:"span",className:"pstrut",style:{height:"2.7em"}}),(0,m.mdx)("span",{parentName:"span",className:"sizing reset-size6 size3 mtight"},(0,m.mdx)("span",{parentName:"span",className:"mord mtight"},(0,m.mdx)("span",{parentName:"span",className:"mord mtight"},"\u2032"))))))))),(0,m.mdx)("span",{parentName:"span",className:"mclose"},")")))))," or the acceptance ratio.\nAll MH proposers must inherit from the ",(0,m.mdx)("inlineCode",{parentName:"p"},"BaseSingleSiteMHProposer")," class and implement the following method, which returns the proposal distribution as a ",(0,m.mdx)("inlineCode",{parentName:"p"},"torch.distribution"),":"),(0,m.mdx)("pre",null,(0,m.mdx)("code",{parentName:"pre",className:"language-py"},"def get_proposal_distribution(self, world: World) -> dist.Distribution\n")),(0,m.mdx)("p",null,"and optionally an adaptation stage if applicable:"),(0,m.mdx)("pre",null,(0,m.mdx)("code",{parentName:"pre",className:"language-py"},"def do_adaptation(self, world: World, accept_log_prob: torch.Tensor, *args, **kwargs) -> None:\n")),(0,m.mdx)("p",null,"One may also override the ",(0,m.mdx)("inlineCode",{parentName:"p"},"propose")," method which is invoked at each iteration, to use any algorithm to propose a new world along with its acceptance log probability. By default the MH algorithm is used."),(0,m.mdx)("pre",null,(0,m.mdx)("code",{parentName:"pre",className:"language-py"},"def propose(self, world: World) -> Tuple[World, torch.Tensor]\n")),(0,m.mdx)("p",null,"For single site algorithms, passing the custom proposer into ",(0,m.mdx)("inlineCode",{parentName:"p"},"SingleSiteInference")," and using the resulting object, which assigns an instance of the proposer per variable, is usually sufficient.\nTo implement custom blocking, which is handled at the algorithm level, the user must define the abstract method ",(0,m.mdx)("inlineCode",{parentName:"p"},"BaseInference.get_proposers")," which defines\nwhich proposers (and which order) to execute for which random variables.  See ",(0,m.mdx)("a",{parentName:"p",href:"/docs/block_inference"},"blocking")," for more examples."),(0,m.mdx)("p",null,"That's it! Let's walk through an example to see how we'd do this in practice."),(0,m.mdx)("h2",{id:"example-custom-proposer"},"Example Custom Proposer"),(0,m.mdx)("p",null,"Here, we implement a custom proposer for locating seismic events on Earth as described in ","[1]",". In particular, the simplified version of the model is used, where one seismic event, denoted in the model by ",(0,m.mdx)("inlineCode",{parentName:"p"},"event_attr()"),", occurs randomly on the surface of the Earth. This event sends seismic energy in a single wave. There are different seismic stations across the surface of the Earth, and each station will noisily record its attributes of time, azimuth, and slowness, denoted by ",(0,m.mdx)("inlineCode",{parentName:"p"},"det_attr(s)"),". The inference problem is to find the ",(0,m.mdx)("inlineCode",{parentName:"p"},"event_attr()")," given the ",(0,m.mdx)("inlineCode",{parentName:"p"},"det_attr(s)"),"."),(0,m.mdx)("pre",null,(0,m.mdx)("code",{parentName:"pre",className:"language-py"},"@bm.random_variable\ndef event_attr():\n  return SeismicEventPrior()\n\n@bm.random_variable\ndef det_attr(station):\n    det_loc = calculate_detection(station, event_attr())\n    return Laplace(det_loc, scale)\n")),(0,m.mdx)("p",null,"There is domain knowledge within seismology to mathematically solve for the most likely attributes of an event given the detection attributes for a specific station. Due to the noisy nature of the data, these predicted locations can be inaccurate, but this can be mitigated by considering the detections in many stations."),(0,m.mdx)("p",null,"An ideal MH proposer for location values would propose locations according to the exact posterior probability of the location given all stations, but computing this posterior or sampling from it is intractable. A simpler but still effective proposer independently computes one predicted location per individual station, which is an easier problem, and then selects, according to a Gaussian mixture model, one of these predicted locations for being proposed. This is effective because, with enough stations, it is likely that one of the predictions will be close to the true location."),(0,m.mdx)("p",null,"With this intuition, we use Bean Machine\u2019s easily implementable proposer interface to write a custom proposer for the ",(0,m.mdx)("inlineCode",{parentName:"p"},"event_attr")," variable, which inspects the ",(0,m.mdx)("inlineCode",{parentName:"p"},"det_attr(s)")," children variables and uses a Gaussian mixture model proposer around the predicted attributes for each of the detections:"),(0,m.mdx)("pre",null,(0,m.mdx)("code",{parentName:"pre",className:"language-py"},"class SingleSiteSeismicProposer(BaseSingleSiteMHProposer):\n\n    def get_proposal_distribution(world: World) -> dist.Distribution:\n        # self.node is given at initialization of the proposer since\n        # there is one proposer per node\n        node_var = world.get_variable(self.node)\n\n        # instead of computing the probability of the event given\n        # the join detections (a computation exponential in the number of detections),\n        # we compute the probability of the event\n        # given each separate detection and propose to use one of them\n        # by sampling from a Gaussian mixture model.\n        inverse_distributions_of_event =\n            [inverted_laplace(world[child_det_attr])\n            for child_det_attr in node_var.children]\n        return create_gaussian_mixture_model(inverse_distributions_of_event)\n")),(0,m.mdx)("p",null,"Since this is a single site proposer, there is one proposer per node and each node is updated independently from all the others.\nIn this case we can just use ",(0,m.mdx)("inlineCode",{parentName:"p"},"SingleSiteInference"),", and run inference with that."),(0,m.mdx)("pre",null,(0,m.mdx)("code",{parentName:"pre",className:"language-py"},"SeismicInference = SingleSiteInference(SingleSiteSeismicProposer)\nobservations = {...}\nsamples = SeismicInference([event_attr()], observations, num_samples)\n")),(0,m.mdx)("p",null,"If we wanted more complex blocking logic, we would define our own inference class by overriding ",(0,m.mdx)("inlineCode",{parentName:"p"},"get_proposers"),".\nNote that the user is free to define the blocking logic however they want; this is one example where we block all the variables together."),(0,m.mdx)("pre",null,(0,m.mdx)("code",{parentName:"pre",className:"language-py"},"class MultiSiteSeismicInference(BaseInference):\n\n    def get_proposers(self, world, target_rvs, num_adaptive_samples):\n        proposers = []\n        for rv in target_rvs:\n            proposers.append(SingleSiteSeismicProposer(rv))\n        # This is a list of all the proposers to use during inference.\n        # In this case, we will block everything together with SequentialProposer\n        # This means that all of the proposers will be shuffled and proposed\n        # in a single MH step.\n        return [SequentialProposer(proposers)]\n\n")),(0,m.mdx)("p",null,"[1]"," Arora, Nimar & Russell, Stuart & Sudderth, Erik. (2013). NET-VISA: Network Processing Vertically Integrated Seismic Analysis. The Bulletin of the Seismological Society of America. 103. 709-729. 10.1785/0120120107."))}c.isMDXComponent=!0}}]);